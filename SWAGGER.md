# Swagger

To make it easier to see what the APIs can do, this project includes
endpoints the return [Swagger](http://swagger.io/) documentation for
the API. These documents are not yet complete or consistent and can
not yet be used to automatically generate API clients or to validate
API responses. But they do let you test out the API and see roughly
what the valid behavior is.

## Initial Setup

Currently, both endpoints must be secured behind HTTP Authentication
to deter unauthorized access. To use these endpoints locally, you can
try the following commands in your shell.

``` shell
export HTTP_USERNAME=username
export HTTP_PASSWORD=password
```

Similarly, to use these endpoints on CloudFoundry, you can do one of
two things. One option is to set the values for `HTTP_BASIC_USERNAME`
or `HTTP_BASIC_PASSWORD` in the
`VCAP_SERVICES.user-services.credentials` sections. Alternatively, you
can explicitly define environment variables if those aren't available.


``` shell
cf set-env crime-data-api HTTP_USERNAME username
cf set-env crime-date-api HTTP_PASSWORD password
cf restage crime-data-api
```

The HTTP authentication is mandatory while the application is being
developed. You can't bypass it by setting the username or password to
blanks. Also, maybe try something different for both of them and limit
distribution only to authorized personnel.

## Swagger Endpoints

The [/swagger/](https://crime-data-api.fr.cloud.gov/swagger.json)
returns a `swagger.json` file located within `crime_data/static/` with
a listing of all the endpoints and their parameters.

The [/swagger-ui/](https://crime-data-api.fr.cloud.gov/swagger-ui/)
path returns the Swagger-UI, an interactive view of the endpoints that
lets you see input parameters, output formats and even lets you run
queries against the API.

## Adding a New Method

Unlike some other project that dynamically generate their Swagger from
decorations applied to methods, we are using a static swagger.json
file for this project. This means that developers will have to update
the swagger file for any new methods or changes to the responses for
existing methods. This is admittedly not immediately convenient, but
it lets us treat the swagger.json file as a contract of what the API
responses should be and use that for functional tests to ensure our
responses conform to what is described.

We are using the [flex](https://github.com/pipermerriam/flex) Swagger
validator in functional tests to verify they match Swagger. To add,
modify your functional test to be like the following

``` python
from flex.core import validate_api_call

def TestCountsEndpoint:
    def test_counts_matches_swagger(self, testapp, swagger):
        res = testapp.get('/counts')
        validate_api_call(swagger, raw_request=res.request, raw_response=res)
```

The `swagger` fixture in py.test loads the
`crime_data/static/swagger.json` into a Flex object so we can use it
for validating that requests and responses match what is in the
Swagger schema.

## Missing Pieces

There are some rough edges, but this has been the fastest way to get a
Swagger UI that tracks the actual functionality of our application as
we develop it. This is still not a complete Swagger specification
though, and we will need to fix the following issues eventually should
we decide to make the Swagger JSON public for outside developers to use:

* Figure out the best ways to represent the allowed but optional query
  parameters for most endpoints within the Swagger API. Since there
  are hundreds of these, they may overwhelm the interface. In
  addition, figuring out these parameters involves a DB query with an
  app context that may not be easily accommodated within a decorator.
* The output schema is currently generated by traversing Marshmallow
  schemas. Figure out if there is a better way to embed documentation
  in the Marshmallow Field type that can be passed along to
  Swagger. In addition, figure out if we can declare that the
  Marshmallow schema might include additional fields.
* It seems a bit redundant to have both `flask-restful` and
  `flask-apispec` on the project. If we could create a `@use_args`
  decorator for `flask-apispec` that might be enough to remove one of
  these libraries.

None of this remaining work is particularly urgent, and it might be
something that we just decide to avoid altogether, since both
`flask-apispec` and `Swagger` itself are meant to be used for RESTful
APIs and the Crime Data API most certainly is not.
